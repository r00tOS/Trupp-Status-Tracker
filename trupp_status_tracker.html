<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Truppüberwachung</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #eef2f7; }
    input[type="text"] {
      margin: 5px 10px 5px 0; padding: 8px; font-size: 1rem; width: 250px;
      border-radius: 5px; border: 1px solid #ccc;
    }
    button {
      padding: 8px 14px; font-size: 0.9rem; border: none;
      border-radius: 5px; cursor: pointer; margin: 4px 2px;
    }
    .reset-btn { background-color: #dc3545; color: white; }
    .export-btn { background-color: #007bff; color: white; }
    .section { margin-top: 40px; }
    .section h2 {
      border-bottom: 2px solid #ccc; padding-bottom: 5px; color: #444;
    }
    .section div {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 16px;
    }
    .trupp {
      border: 2px solid #ccc; padding: 15px; border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1); background: #fff;
      transition: transform 0.4s ease, opacity 0.4s ease;
    }
    .trupp.move-out {
      transform: scale(0.9) translateX(100px);
      opacity: 0;
    }
    .trupp.move-in {
      transform: scale(1.05) translateX(-100px);
      opacity: 0;
    }
    .trupp.move-in-active {
      transform: scale(1) translateX(0);
      opacity: 1;
    }
    .einsatz { border-left: 5px solid #28a745; background: #d4edda; }
    .pause { border-left: 5px solid #007bff; background: #d6eaff; }
    .nicht-einsatzbereit { border-left: 5px solid #6c757d; background: #e2e3e5; }
    .ueberzogen { border: 2px solid red; }
    .rueckhaltung { border: 2px solid gold; background-color: #fff9e6; opacity: 0.6; }
    .patient { border: 2px solid gold; background-color: #fff9e6; }
    .spielfeldrand { border: 2px solid orange; background-color: #ffe8cc; }
    .trupp-header {
      display: flex; justify-content: space-between; align-items: center;
    }
    .trupp input[type="text"] { margin-top: 5px; width: 100%; }
  </style>
</head>
<body>
  <h1>Trupp Status Tracker</h1>
  <input type="text" id="newTruppName" placeholder="Neuer Truppname" />
  <button onclick="addTrupp()">Trupp hinzufügen</button>
  <button onclick="addSKTrupps()">SK 10–60 hinzufügen</button>
  <button class="reset-btn" onclick="resetAll()">Alle Trupps löschen</button>
  <button class="export-btn" onclick="exportPDF()">PDF Export</button>

  <div class="section"><h2>Im Einsatz</h2><div id="einsatzContainer"></div></div>
  <div class="section"><h2>In Pause</h2><div id="pauseContainer"></div></div>
  <div class="section"><h2>Nicht Einsatzbereit</h2><div id="nichtContainer"></div></div>

  <script>
    function formatTime(ms) {
      const d = new Date(ms);
      return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    let trupps = JSON.parse(localStorage.getItem('trupps') || '[]');

    function saveTrupps() {
      localStorage.setItem('trupps', JSON.stringify(trupps));
    }

    function resetAll() {
      if (confirm("Willst du wirklich alle Daten löschen?")) {
        localStorage.removeItem('trupps');
        trupps = [];
        renderTrupps();
      }
    }

    function addTrupp(name = null) {
      const input = name || document.getElementById("newTruppName").value.trim();
      if (!input) return;
      trupps.push({
        name: input, status: "Nicht Einsatzbereit",
        lastStatusChange: Date.now(),
        currentPauseStart: Date.now(),
        currentEinsatzStart: null,
        totalPauseTime: 0,
        einsatzHistorie: [],
        patientHistorie: [],
        patientInput: "",
        currentOrt: "",
        einsatzStartOrt: null,
        patientStart: null
      });
      if (!name) document.getElementById("newTruppName").value = "";
      saveTrupps();
      renderTrupps();
    }

    function addSKTrupps() {
      for (let i = 10; i <= 60; i += 5) addTrupp(`SK ${i}`);
    }

    function updateTrupp(index, status) {
      const trupp = trupps[index];
      const now = Date.now();
      const istEinsatz = ["Streife", "Patient", "Spielfeldrand"].includes(status);
      const warEinsatz = ["Streife", "Patient", "Spielfeldrand"].includes(trupp.status);

      if (trupp.status === "Patient" && trupp.patientInput && trupp.patientStart) {
        trupp.patientHistorie.push({ nummer: trupp.patientInput, von: trupp.patientStart, bis: now });
        trupp.patientInput = "";
        trupp.patientStart = null;
      }

      if (trupp.status === "Streife" && trupp.currentOrt && trupp.einsatzStartOrt) {
        trupp.einsatzHistorie.push({ ort: trupp.currentOrt, von: trupp.einsatzStartOrt, bis: now });
        trupp.currentOrt = "";
        trupp.einsatzStartOrt = null;
      }

      if (!warEinsatz && istEinsatz && trupp.currentPauseStart) {
        trupp.totalPauseTime += now - trupp.currentPauseStart;
        trupp.currentPauseStart = null;
        trupp.currentEinsatzStart = now;
      } else if (warEinsatz && !istEinsatz) {
        trupp.currentEinsatzStart = null;
        trupp.currentPauseStart = now;
      }

      if (status === "Patient") trupp.patientStart = now;
      if (status === "Streife") trupp.einsatzStartOrt = now;

      trupp.status = status;
      trupp.lastStatusChange = now;
      saveTrupps();
      renderTrupps();
    }

    function deleteTrupp(index) {
  const key = trupps[index].name;
  const el = document.querySelector(`[data-key="${key}"]`);
  if (el) {
    el.classList.add('move-out');
    setTimeout(() => {
      trupps.splice(index, 1);
      saveTrupps();
      renderTrupps();
    }, 300); // Delay matches CSS transition time
  } else {
    trupps.splice(index, 1);
    saveTrupps();
    renderTrupps();
  }
}

    function renderTrupps() {
      const now = Date.now();

      const prevRects = new Map();
      document.querySelectorAll('.trupp').forEach(el => {
        if (el.dataset.key) prevRects.set(el.dataset.key, el.getBoundingClientRect());
      });

      einsatzContainer.innerHTML = pauseContainer.innerHTML = nichtContainer.innerHTML = "";
      const einsatz = [], pause = [], nicht = [];

      trupps.forEach((trupp, i) => {
        const div = document.createElement("div");
        div.className = "trupp";
if (!prevRects.has(trupp.name)) {
  div.classList.add("move-in");
  setTimeout(() => div.classList.add("move-in-active"), 50);
}
        div.dataset.key = trupp.name;

        const einsatzzeit = trupp.currentEinsatzStart ? now - trupp.currentEinsatzStart : 0;
        let pausenzeit = 0, totalPause = trupp.totalPauseTime;
        if (trupp.currentPauseStart && !["Streife", "Patient", "Spielfeldrand"].includes(trupp.status)) {
          pausenzeit = now - trupp.currentPauseStart;
          totalPause += pausenzeit;
        }

        if (trupp.currentEinsatzStart && einsatzzeit > 45 * 60000) div.classList.add("ueberzogen");
        if (trupp.status === "Einsatzbereit in Rückhaltung") div.classList.add("rueckhaltung");
        if (trupp.status === "Patient") div.classList.add("patient");
        if (trupp.status === "Spielfeldrand") div.classList.add("spielfeldrand");
        if (["Streife", "Patient", "Spielfeldrand"].includes(trupp.status)) div.classList.add("einsatz");
        else if (["Einsatzbereit in UHS", "Einsatzbereit unterwegs", "Einsatzbereit in Rückhaltung"].includes(trupp.status)) div.classList.add("pause");
        else div.classList.add("nicht-einsatzbereit");

        const min = ms => Math.floor(ms / 60000);
        const timeDisplay = trupp.currentEinsatzStart && trupp.status !== "Einsatzbereit in Rückhaltung"
          ? `Aktuelle Einsatzzeit: ${min(einsatzzeit)} Min`
          : `Aktuelle Pausenzeit: ${min(pausenzeit)} Min${trupp.status === 'Einsatzbereit in Rückhaltung' ? ' (Rückhaltung zählt als Pause)' : ''}`;

        const gesamtPause = `Gesamte Pausenzeit: ${min(totalPause)} Min`;

        const progress = Math.min(einsatzzeit / (45 * 60000), 1);
const progressBar = trupp.currentEinsatzStart && trupp.status !== 'Einsatzbereit in Rückhaltung' ?
  `<div style='background:#ccc;height:8px;border-radius:4px;margin-top:4px;'>
     <div style='height:8px;width:${Math.floor(progress*100)}%;background:#28a745;border-radius:4px;'></div>
   </div>` : "";

div.innerHTML = `
          <div class="trupp-header">
  <h3>${trupp.name}</h3>
  ${trupp.status === 'Nicht Einsatzbereit' ? `<button class="delete-btn" onclick="deleteTrupp(${i})">×</button>` : ''}
          </div>
          <p>Status: ${trupp.status}</p>
          <p>${timeDisplay}</p>
          ${progressBar}
          <p>${gesamtPause}</p>
          ${trupp.status === "Streife" ? `<input type="text" placeholder="Einsatzort" value="${trupp.currentOrt || ''}" onchange="trupps[${i}].currentOrt = this.value; saveTrupps()" />` : ''}
          ${trupp.status === "Patient" ? `<input type="text" placeholder="Patientennummer" value="${trupp.patientInput || ''}" onchange="trupps[${i}].patientInput = this.value; saveTrupps()" />` : ''}
          <div>
            <button onclick="updateTrupp(${i}, 'Nicht Einsatzbereit')">Nicht Einsatzbereit</button>
            <button onclick="updateTrupp(${i}, 'Einsatzbereit in UHS')">In UHS</button>
            <button onclick="updateTrupp(${i}, 'Einsatzbereit unterwegs')">Unterwegs</button>
            <button onclick="updateTrupp(${i}, 'Einsatzbereit in Rückhaltung')">In Rückhaltung</button>
            <button onclick="updateTrupp(${i}, 'Streife')">Streife</button>
            <button onclick="updateTrupp(${i}, 'Patient')">Patient</button>
            <button onclick="updateTrupp(${i}, 'Spielfeldrand')">Spielfeldrand</button>
          </div>
          <p><strong>Einsatzorte:</strong><br>
            ${trupp.einsatzHistorie.length ? trupp.einsatzHistorie.map(h => `${h.ort} (${formatTime(h.von)} - ${formatTime(h.bis)})`).join("<br>") : "–"}
          </p>
          <p><strong>Patientennummern:</strong><br>
            ${trupp.patientHistorie.length ? trupp.patientHistorie.map(h => `${h.nummer} (${formatTime(h.von)} - ${formatTime(h.bis)})`).join("<br>") : "–"}
          </p>
        `;

        const einsatzSort = trupp.status === "Spielfeldrand" ? 99 : trupp.status === "Patient" ? 1 : 0;
        if (["Streife", "Patient", "Spielfeldrand"].includes(trupp.status)) einsatz.push({ el: div, sort: einsatzSort });
        else if (["Einsatzbereit in UHS", "Einsatzbereit unterwegs"].includes(trupp.status)) pause.push({ el: div, sort: pausenzeit });
        else if (trupp.status === "Einsatzbereit in Rückhaltung") pause.push({ el: div, sort: -1 });
        else nicht.push({ el: div, sort: pausenzeit });
      });

      einsatz.sort((a, b) => {
        if (a.sort !== b.sort) return a.sort - b.sort;
        const timeA = trupps.find(t => t.name === a.el.dataset.key)?.currentEinsatzStart || 0;
        const timeB = trupps.find(t => t.name === b.el.dataset.key)?.currentEinsatzStart || 0;
        return (timeA || 0) - (timeB || 0);
      }).forEach(t => einsatzContainer.appendChild(t.el));
      pause.sort((a, b) => b.sort - a.sort).forEach(t => pauseContainer.appendChild(t.el));
      nicht.sort((a, b) => b.sort - a.sort).forEach(t => nichtContainer.appendChild(t.el));

      requestAnimationFrame(() => {
        document.querySelectorAll('.trupp').forEach(el => {
          const key = el.dataset.key;
          const oldRect = prevRects.get(key);
          if (!oldRect) return;
          const newRect = el.getBoundingClientRect();
          const dx = oldRect.left - newRect.left;
          const dy = oldRect.top - newRect.top;
          if (dx !== 0 || dy !== 0) {
            el.style.transition = 'none';
            el.style.transform = `translate(${dx}px, ${dy}px)`;
            requestAnimationFrame(() => {
              el.style.transition = 'transform 0.4s ease';
              el.style.transform = '';
            });
          }
        });
      });
    }

    renderTrupps();
    setInterval(renderTrupps, 30000);

    async function exportPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      let y = 10;

      doc.setFontSize(14);
      doc.text("Truppübersicht", 10, y);
      y += 10;

      trupps.forEach(trupp => {
        const now = Date.now();
        const pausenzeit = trupp.currentPauseStart ? now - trupp.currentPauseStart : 0;
        const totalPause = Math.floor((trupp.totalPauseTime + pausenzeit) / 60000);

        doc.setFontSize(12);
        doc.text(`Trupp: ${trupp.name}`, 10, y);
        y += 6;
        doc.text(`Status: ${trupp.status}`, 10, y);
        y += 6;
        doc.text(`Gesamte Pausenzeit: ${totalPause} Min`, 10, y);
        y += 6;

        const einsatzHistorie = trupp.einsatzHistorie.length
          ? trupp.einsatzHistorie.map(e => `• ${e.ort} (${formatTime(e.von)} - ${formatTime(e.bis)})`)
          : ["–"];
        doc.text("Einsatzorte:", 10, y); y += 6;
        einsatzHistorie.forEach(line => { doc.text(line, 15, y); y += 6; });

        const patientHistorie = trupp.patientHistorie.length
          ? trupp.patientHistorie.map(p => `• ${p.nummer} (${formatTime(p.von)} - ${formatTime(p.bis)})`)
          : ["–"];
        doc.text("Patientennummern:", 10, y); y += 6;
        patientHistorie.forEach(line => { doc.text(line, 15, y); y += 6; });

        y += 8;
        if (y > 270) {
          doc.addPage();
          y = 10;
        }
      });

      doc.save("trupp_status_report.pdf");
    }
  </script>
</body>
</html>
